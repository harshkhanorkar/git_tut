import pandas as pd

# Load the Excel file
file_path = "P&L Review_ Working File_3rd Mar 2025.xlsx"
sheet_name = "5806"

# Read the Excel sheet
df = pd.read_excel(file_path, sheet_name=sheet_name)

# Identify numeric (month) columns dynamically
month_columns = df.select_dtypes(include=['number']).columns.tolist()

if len(month_columns) < 2:
    raise ValueError("Not enough month columns to compute YTD and Percentage of Variance")

# Compute YTD (Last Month - Second Last Month)
df["YTD"] = df[month_columns[-1]] - df[month_columns[-2]]

# Compute Percentage of Variance as (YTD / Last Month) * 100
df["Percentage of variance"] = (df["YTD"] / df[month_columns[-1]]) * 100

# Handle division by zero (avoid infinite values)
df["Percentage of variance"].replace([float("inf"), -float("inf")], 0, inplace=True)
df["Percentage of variance"].fillna(0, inplace=True)  # Replace NaN with 0

# Add an empty CFO Commentary column
df["CFO Commentary"] = ""

# Save back to Excel
output_file = "Updated_P&L_Review.xlsx"
with pd.ExcelWriter(output_file, engine="xlsxwriter") as writer:
    df.to_excel(writer, sheet_name=sheet_name, index=False)

print(f"Updated file saved as {output_file}")
